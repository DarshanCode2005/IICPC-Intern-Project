name: Deploy to AWS Free Tier EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: "1.21"

    - name: Build Go binary
      run: |
        GOOS=linux GOARCH=amd64 go build -o engine ./cmd/main.go

    - name: Copy SSH key
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
        chmod 600 key.pem

    - name: Upload binary to EC2
      run: |
        scp -o StrictHostKeyChecking=no -i key.pem engine ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/engine

    - name: Deploy binary on EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          sudo systemctl stop engine.service || true

          sudo mv /tmp/engine /usr/local/bin/engine
          sudo chmod +x /usr/local/bin/engine

          # Update env file
          echo "${{ secrets.ENGINE_ENV }}" | sudo tee /home/ubuntu/.env >/dev/null
          sudo chown ubuntu:ubuntu /home/ubuntu/.env

          sudo systemctl daemon-reload
          sudo systemctl restart engine.service

          yes | sudo docker system prune
EOF

    - name: Cleanup local key
      run: rm key.pem
